# Feature Spec â€” GPS / Geo-tagging

## Scope
- Objective: Capture device latitude/longitude at the time a site is saved and make coordinates available across exports.
- In Scope: Location acquisition service abstraction, UI controls for opt-in capture, persistence within project/site model, export hooks (CSV/KML), operator feedback on location status.
- Out of Scope: Real-time tracking, map rendering inside the app, network lookups, background location updates.
- Stakeholders: Field operators, QC reviewers, report preparation staff.

## Acceptance Criteria
- [ ] Operator can enable/disable GPS capture per session (default off) via settings or save dialog.
- [ ] When enabled, saving a site attaches lat/lon (WGS84) with accuracy metadata to the stored record.
- [ ] Exported CSV/KML include captured coordinates; when absent, fields are blank with no crash.
- [ ] UI indicates capture state (pending/success/error) without blocking save flow; offline use remains functional.
- [ ] Permissions handling (desktop bridge/WSL) provides actionable error messaging when location is unavailable.

## Affected Files
- `lib/models` (site/project model extensions)
- `lib/state/settings_state.dart` and related controllers
- `lib/services/persistence.dart`, `lib/services/storage_service.dart`
- `lib/services/export_service.dart`, `lib/services/csv_io.dart`, new `lib/services/kml_export.dart` (if needed)
- `lib/ui/site_edit` and related forms/dialogs
- `pubspec.yaml` (dependencies: e.g., `geolocator`, desktop location shim)
- `test/` additions covering location persistence and export formatting

## Testing Plan
- Unit tests ensuring coordinates are saved/omitted correctly and serialized through exports.
- Widget tests for save dialog toggles and state feedback (mocking location service).
- Manual QA on WSL desktop build verifying permission prompts, save workflow, and generated CSV/KML outputs offline.
- Regression validation: run `scripts/ci/test_wsl.sh` to cover analyzer/format/test loop.

## Rollback Plan
- Revert GPS-specific model changes and feature flag toggles.
- Remove added dependencies from `pubspec.yaml` and lockfile.
- Drop new export artifacts or columns and re-run CI loop to confirm baseline.
- Provide configuration switch (e.g., feature flag) to quickly disable GPS capture while maintaining non-location exports.

